<!doctype html>  
<!--[if lt IE 7 ]> <html lang="en-us" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en-us" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en-us" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en-us" class="no-js ie9"> <![endif]-->   
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en-us" class="no-js"> <!--<![endif]-->

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" >
  <meta charset="utf-8">
  <meta name="author" content="Jen Hanni">

  
    <title>L2 Cache Simulator | Wickerbox</title>
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <!-- The Columnal Grid (1140px wide base, load first), Type and image presets, and mobile stylesheet -->
        <link rel="stylesheet" href="/css/columnal.css" type="text/css" media="screen" />

  <!-- Fixes for IE -->
        <!--[if lt IE 9]>
        <link rel="stylesheet" href="/css/ie.css" type="text/css" media="screen" />
        <![endif]-->

  <!-- use "fixed-984px-ie.css" or "fixed-960px-ie.css for a 984px or 960px fixed width for IE6 and 7 -->
        <!--[if lte IE 7]>
        <link rel="stylesheet" href="/css/fixed-984px-ie.css" type="text/css" media="screen" />
        <![endif]-->

  <!-- Fixes for IE6, only needed if IE 6 will be supported - width must match 984px or 960px of css file used above -->
  <!-- Use .imagescale to fix IE6 issues with full-column width images (class must be added to any image wider than the column it is placed into) -->
        <!--[if lte IE 6]>
        <link rel="stylesheet" href="/css/ie6-984px.css" type="text/css" media="screen" />
        <![endif]-->
  <!-- End fixes for IE -->

  <!-- Customizations here --> 
       <link rel="stylesheet" href="/css/custom.css" type="text/css" media="screen" />

  <!-- Properties -->
       <meta property="og:site_name" content="Wickerbox"/>
       <meta property="og:title" content="L2 Cache Simulator"/>
       
          <meta property="og:description" content="Simulates a set associative, write-allocate, MESI L2 cache."/>
       

  <!-- load jQuery -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

  <!-- PWI Scripts and CSS -->
        <link href="/pwi/css/pwi.css" rel="stylesheet" type="text/css"/>
	<link href="/pwi/js/jquery.fancybox/jquery.fancybox.css" rel="stylesheet" type="text/css"/>
	<link href="/pwi/js/jquery.fancybox/helpers/jquery.fancybox-buttons.css?v=2.0.5" rel="stylesheet" type="text/css"/>

	<script src="/pwi/js/jquery.pwi.js" type="text/javascript"></script>
	<script src="/pwi/js/jquery.fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
	<script src="/pwi/js/jquery.fancybox/helpers/jquery.fancybox-buttons.js?v=2.0.5" type="text/javascript"></script>

  <!-- Typekit --> 
        <script type="text/javascript" src="http://use.typekit.com/xvs6rfx.js"></script>
        <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

  

</head>

<body>

<div class="container header">
  <div class="row">
    <div class="col_2">
      <h1><a href="/index.html">Wickerbox</a></h1>
    </div>

    <div class="col_7" style="text-align:center;">
    <ul id="navcontainer">
      <li><a href="/about/">About</a></li>
      <li><a href="/blog/">Blog</a></li>
      <li><a href="/projects/">Projects</a></li>
      <li><a href="/travels/">Travels</a></li>
      <li><a href="/aviation-history/">History</a></li>
      <li><a href="/two-cats/">Cats</a></li>
    </ul>
    </div>

    <div class="col_3 last" style="text-align:center;">
      <ul id="logocontainer">
        <li><a href="https://plus.google.com/117081002500022017940/" rel="publisher" target="_new"><img align="middle" src="/images/icons/googleplus.png" alt="G+"></a></li>
        <li><a href="http://github.com/wicker"><img src="/images/icons/github.png" alt="GH" align="middle"></a></li>
        <li><a href="http://www.linkedin.com/profile/view?id=43039351&trk=tab_pro"><img src="/images/icons/linkedin.png" alt="LIn" align="middle"></a></li>
        <li><a href="#"><img src="/images/icons/feed.png" alt="RSS" align="middle"></a></li>
      </ul>
    </div>
  </div>
</div>

<div style="text-align:center;">

<div class="container">

    <div class="row">

  

    <div class="col_12 last textbox">
        <h3>L2 Cache Simulator</h3>
        <h4 style="text-align:center;">2012 ~ Portland State University</h4>
        <h4 style="text-align:justify;">Simulates a set associative, write-allocate, MESI L2 cache.</h4>
        <div class="inside"><p>Our term project for the microprocessor system design course at Portland State in the Fall 2011 quarter was to write a small program in Verilog, C, or C++ to simulate (not synthesize) the behavior of a write-allocate, <span class="caps">MESI</span> protocol, four-way set associative L2 cache with 4K lines of 64 bytes data each.</p>
<p>We successfully wrote our program in C and passed the course. Having written most of the code myself, I could see a lot of areas where I could improve it and so, with permission from my partners, I rewrote the code over winter break to be easily extensible to different sizes and set associativities of cache. I shrunk the program from 646 lines to 377 lines, cutting it by 42%, and made it much cleaner and easier to follow. The sample input and output are at the bottom, and all the files (and commit history) are available at my <a href="http://github.com/wicker/l2cache/">GitHub repository</a> under the <span class="caps">MIT</span> license.</p>
<h2>Background</h2>
<p>It&#8217;s standard practice for a computer&#8217;s processor to contain caches, either on the chip or very physically nearby, which are basically areas of reserved space to store information between the processor and its full main memory. Access times to the main memory are many times larger than access times to the cache; for example, a cache access could take a few nanoseconds where a memory access could take more than a hundred. Therefore, it&#8217;s in the CPU&#8217;s interest to try to store data in the cache that it will likely need in the near future.</p>
<p>A common configuration is to have multiple levels of caches, from a typically much smaller on-chip L1 cache to an off-chip L2 or L3 cache which might be relatively larger. In a dual-core processor,each processor probably has its own on-chip L1 cache but may or may not share a single L2 cache.</p>
<p>Now, it&#8217;s relatively simple to handle storing into and evicting from a cache if only one processor has access. For example, the &#8220;Least Recently Used&#8221; eviction policy uses one or more bits of the item to indicate which item in a particular index is the oldest, and thus the least likely to be used again in the near future. Thus, when the processor needs to add a new item into that index line, it knows which of the items in the index can be safely replaced.</p>
<p>It gets a little more complicated when other considerations and extra processors come into place. An item might be recently written to memory but its counterpart in the cache simply has its bits marked &#8216;dirty&#8217; because it hasn&#8217;t been replaced yet. But then which item should be evicted if the cache index in question has both an item with a dirty bit and an item marked least-recently-used? What if one of two processors updates something in memory and sets the dirty bit in the L2 cache &#8212; how does the other processor know to invalidate their own copy in their own L1 cache, which the first processor can&#8217;t see?</p>
<p>This is called cache coherency and it can be addressed in a wide variety of ways. Our solution implemented the <a href="http://en.wikipedia.org/wiki/MESI_protocol"><span class="caps">MESI</span></a> (Modified-Exclusive-Shared-Invalid) protocol which depended on modifying two bits (for the four possibilities) and checking those and the <span class="caps">LRU</span> bit to make eviction and write decisions.</p>
<h2>Simulating the L2 Cache in C</h2>
<p>Our term project for the microprocessor system design course at Portland State in the Fall 2011 quarter was to write a small program in Verilog, C, or C++ to simulate (not synthesize) the behavior of a write-allocate, <span class="caps">MESI</span> protocol, four-way set associative L2 cache with 4K lines of 64 bytes data each. Our C program was tested by our professor by running a text file containing lines of the type</p>
<p><small>&#8216;n address&#8217;</small></p>
<p>where</p>
<p><small>&#8216;n&#8217; could be 0-9 and indicated the desired operation type and<br />
&#8216;address&#8217; was some 32-bit address.</small></p>
<p>Upon a command input of &#8216;9&#8217; the cache would send (in a somewhat pretty format) all the lines that had been accessed to an output file. We were not required to move, track, or otherwise handle any actual data in the cache. We only had to track addresses and cache locations.</p>
<h2>Extending the Cache</h2>
<p>I felt that the quality of the code, especially after last-minute fixes, could be improved. Our prof challenged me to improve extensibility so that it would take less than fifteen minutes to change the size (number of lines) or set associativity (direct-mapped, fully associative).</p>
<p>The original file (<a href="https://raw.github.com/wicker/l2cache/master/original.c">original.c</a>) had 646 lines, used &#8216;while&#8217; loops, assumed a four-way cache and so specified 0-3 for all functions that checked all ways in an index. It haphazardly included <span class="caps">DRAM</span> and L1 printf access notes for testing and display, which we thought at the time was a good idea to keep track of what was going on but they were inconsistent and really failing for any functional purpose. The cache also repeated sections of code instead of calling a function and, finally, it failed on the case of cache coherency.</p>
<p>I spent a week over winter break and tried to fix most of those problems.</p>
<p>The final revised version (<a href="https://raw.github.com/wicker/l2cache/master/main.c">main.c</a>) has 377 lines, uses &#8216;for&#8217; loops, and depends on a global variable to set cache size and can thus be used to simulate a direct mapped or x-way set associative cache. It contains no <span class="caps">DRAM</span> or L1 printf access notes as they were outside the scope of the simulation and, again, never followed up on in the first place. The focus was the cache &#8211; not the things to which the cache was connected. This version makes use of functions where appropriate, has an overhauled <span class="caps">LRU</span> algorithm that&#8217;s much more simple, and makes use only of a single output file for the display.</p>
<p>The final cache simulator still fails on one of the cases of cache coherency but I added a script to simplify testing/running the whole thing and, anyway, you can&#8217;t have everything you want in life.</p>
<h2>Get the Code</h2>
<p>&raquo; <a href="http://github.com/wicker/l2cache/">GitHub repository</a></p>
<p>To run this cache, you will need the following files:</p>
<p><a href="https://raw.github.com/wicker/l2cache/master/main.c">main.c</a> &#8211; contains the program itself<br />
<a href="https://raw.github.com/wicker/l2cache/master/testfile.din">testfile.din</a> &#8211; the list of &#8216;n&#8217; &#8216;address&#8217; inputs<br />
<a href="https://raw.github.com/wicker/l2cache/master/Makefile">Makefile</a> &#8211; for ease of removing and compiling files during test<br />
<a href="https://raw.github.com/wicker/l2cache/master/run">run</a> &#8211; this is the script</p>
<p>Download these four files into one directory and cd to that directory. Then give the script &#8216;run&#8217; permission to run and then &#8230; run it.</p>
<p><small>chmod u+x run</small><br />
<small>./run</small></p>
<h2>Script</h2>
<p>main.c will take in the testfile.din and printf the stats of the entire run.</p>
<p>It will also generate a display.txt on every iteration where n = 9. This will display everything in the cache but make no changes. The cache will be reset on every iteration where n = 8.</p>
<p><small>#!/bin/bash</small><br />
<small># Test the L2 cache</small><br />
<small>make clean</small><br />
<small>make all</small><br />
<small>./main</small><br />
<small>cat display.txt</small></p>
<h2>Sample Input</h2>
<p><img src="/images/project/l2cache/l2cache-input.png"></p>
<h2>Sample Output</h2>
<p><img src="/images/project/l2cache/l2cache-output.png"></p></div>
    </div>

  

    </div><!-- end row -->


</div><!-- end container -->



</div>

 
  <div class="container footer">
    <div class="row">
      <div class="col_12 last">
        <div style="padding: 10px 25px 10px 25px;">
          &nbsp; &nbsp; <a href="/tags/arizona/" title="Pages tagged arizona" style="font-size: 176%" rel=\"tag\">arizona</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/australia/" title="Pages tagged australia" style="font-size: 116%" rel=\"tag\">australia</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/avt/" title="Pages tagged avt" style="font-size: 100%" rel=\"tag\">avt</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/boards/" title="Pages tagged boards" style="font-size: 100%" rel=\"tag\">boards</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/bosnia/" title="Pages tagged bosnia" style="font-size: 100%" rel=\"tag\">bosnia</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/botanical/" title="Pages tagged botanical" style="font-size: 126%" rel=\"tag\">botanical</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/c/" title="Pages tagged c" style="font-size: 100%" rel=\"tag\">c</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/california/" title="Pages tagged california" style="font-size: 142%" rel=\"tag\">california</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/code/" title="Pages tagged code" style="font-size: 116%" rel=\"tag\">code</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/colorado/" title="Pages tagged colorado" style="font-size: 138%" rel=\"tag\">colorado</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/croatia/" title="Pages tagged croatia" style="font-size: 100%" rel=\"tag\">croatia</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/desert/" title="Pages tagged desert" style="font-size: 174%" rel=\"tag\">desert</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/endurance-days/" title="Pages tagged endurance days" style="font-size: 154%" rel=\"tag\">endurance days</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/england/" title="Pages tagged england" style="font-size: 116%" rel=\"tag\">england</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/flying/" title="Pages tagged flying" style="font-size: 174%" rel=\"tag\">flying</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/geology/" title="Pages tagged geology" style="font-size: 151%" rel=\"tag\">geology</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/hardware/" title="Pages tagged hardware" style="font-size: 126%" rel=\"tag\">hardware</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/hiking/" title="Pages tagged hiking" style="font-size: 168%" rel=\"tag\">hiking</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/historic/" title="Pages tagged historic" style="font-size: 154%" rel=\"tag\">historic</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/iraq/" title="Pages tagged iraq" style="font-size: 138%" rel=\"tag\">iraq</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/jekyll/" title="Pages tagged jekyll" style="font-size: 100%" rel=\"tag\">jekyll</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/marine-corps/" title="Pages tagged marine corps" style="font-size: 156%" rel=\"tag\">marine corps</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/nevada/" title="Pages tagged nevada" style="font-size: 116%" rel=\"tag\">nevada</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/ninety-nines/" title="Pages tagged ninety-nines" style="font-size: 100%" rel=\"tag\">ninety-nines</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/norway/" title="Pages tagged norway" style="font-size: 100%" rel=\"tag\">norway</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/ocean/" title="Pages tagged ocean" style="font-size: 142%" rel=\"tag\">ocean</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/oregon/" title="Pages tagged oregon" style="font-size: 158%" rel=\"tag\">oregon</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/phoenix/" title="Pages tagged phoenix" style="font-size: 116%" rel=\"tag\">phoenix</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/projects/" title="Pages tagged projects" style="font-size: 162%" rel=\"tag\">projects</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/quadcopter/" title="Pages tagged quadcopter" style="font-size: 100%" rel=\"tag\">quadcopter</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/robots/" title="Pages tagged robots" style="font-size: 132%" rel=\"tag\">robots</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/rockets/" title="Pages tagged rockets" style="font-size: 100%" rel=\"tag\">rockets</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/singapore/" title="Pages tagged singapore" style="font-size: 100%" rel=\"tag\">singapore</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/sites/" title="Pages tagged sites" style="font-size: 100%" rel=\"tag\">sites</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/slovenia/" title="Pages tagged slovenia" style="font-size: 100%" rel=\"tag\">slovenia</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/solar-system/" title="Pages tagged solar system" style="font-size: 100%" rel=\"tag\">solar system</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/sonora/" title="Pages tagged sonora" style="font-size: 116%" rel=\"tag\">sonora</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/sweden/" title="Pages tagged sweden" style="font-size: 100%" rel=\"tag\">sweden</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/switzerland/" title="Pages tagged switzerland" style="font-size: 126%" rel=\"tag\">switzerland</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/tortoise/" title="Pages tagged tortoise" style="font-size: 100%" rel=\"tag\">tortoise</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/trains/" title="Pages tagged trains" style="font-size: 116%" rel=\"tag\">trains</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/travels/" title="Pages tagged travels" style="font-size: 200%" rel=\"tag\">travels</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/tucson/" title="Pages tagged tucson" style="font-size: 100%" rel=\"tag\">tucson</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/turkey/" title="Pages tagged turkey" style="font-size: 156%" rel=\"tag\">turkey</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/utah/" title="Pages tagged utah" style="font-size: 132%" rel=\"tag\">utah</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/washington/" title="Pages tagged washington" style="font-size: 100%" rel=\"tag\">washington</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/water/" title="Pages tagged water" style="font-size: 100%" rel=\"tag\">water</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/wildlife/" title="Pages tagged wildlife" style="font-size: 126%" rel=\"tag\">wildlife</a> &nbsp; &nbsp;&nbsp; &nbsp; <a href="/tags/yuma/" title="Pages tagged yuma" style="font-size: 149%" rel=\"tag\">yuma</a> &nbsp; &nbsp;
        </div>
      </div>
    </div>
  </div>


</div>

</body>
</html>
